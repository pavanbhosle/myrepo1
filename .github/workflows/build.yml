name: Java CI with Maven

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build:

    runs-on: [self-hosted, linux]

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Install up AWS CLI
      run: |
        sudo apt-get update
        curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
        unzip awscliv2.zip
        sudo ./aws/install
        aws --version

    - name: Set up AWS CLI    
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: 'us-west-2'

    - name: Launch EC2 Instance
      id: ec2-launch
      run: |
        # Launch EC2 instance using the AMI
         INSTANCE_ID=$(aws ec2 run-instances --image-id ami-0cb9a84fd84e4b269 --count 1 --instance-type t2.micro --key-name MyFirstEC2-KP --region us-east-2 --query 'Instances[0].InstanceId' --output text)
         echo "INSTANCE_ID=${INSTANCE_ID}" >> $GITHUB_ENV
        # Tag the instance for identification
         aws ec2 create-tags --resources $INSTANCE_ID --tags Key=Name,Value=GitHubActionsRunner

    - name: Wait for EC2 Instance to be Running
      run: |
        aws ec2 wait instance-running --instance-ids ${{ env.INSTANCE_ID }}

    - name: Set up SSH Configuration
      run: |
        # Install SSH if not already available
        sudo apt-get install -y ssh
        # Add SSH known hosts
        ssh-keyscan -H ec2-18-188-114-70.us-east-2.compute.amazonaws.com >> ~/.ssh/known_hosts

    - name: Run Build on EC2 Instance
      run: |
          # SSH into the EC2 instance and run the build script
          ssh -o StrictHostKeyChecking=no -i /path/to/your-key.pem ubuntu@ec2-18-188-114-70.us-east-2.compute.amazonaws.com << 'EOF'
            # Download the repository
            git clone https://github.com/pavanbhosle/myrepo1.git
            cd your-repo

            # Install Maven
            sudo apt-get install -y maven

    - name: Cache Maven packages
      uses: actions/cache@v2
      with:
        path: ~/.m2/repository
        key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
        restore-keys: |
          ${{ runner.os }}-maven-

    - name: Build with Maven
      run: mvn clean package

    - name: Create ZIP File
      run: zip -r java-maven-project.zip target/
      
    - name: Upload ZIP File
      uses: actions/upload-artifact@v3
      with:
        name: java-maven-project
        path: java-maven-project.zip
